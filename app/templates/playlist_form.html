{% extends "base.html" %}

{% macro render_loop_options(nodes, level=0) %}
  {% for node in nodes %}
    {% if node.is_file %}
      {% set indent = '&nbsp;' * (level * 4) %}
      <option value="{{ node.path }}" {% if playlist and playlist.loop_video == node.path %}selected{% endif %}>{{ indent | safe }}{{ node.name }}</option>
    {% else %}
      {% set indent = '&nbsp;' * (level * 4) %}
      <option value="" disabled class="bg-light text-muted">{{ indent | safe }}{{ node.path }}/</option>
      {{ render_loop_options(node.children, level + 1) }}
    {% endif %}
  {% endfor %}
{% endmacro %}

{% macro render_video_checkboxes(nodes) %}
  {% for node in nodes %}
    {% if node.is_file %}
      {% set input_id = 'video-' ~ node.path|replace('/', '_')|replace('.', '_') %}
      <li
        class="list-group-item d-flex align-items-center justify-content-between gap-2"
        data-video-entry
        data-video-path="{{ node.path }}"
        data-video-name="{{ node.name }}"
        data-video-src="{{ url_for('serve_video', filename=node.path) }}"
      >
        <div class="d-flex align-items-center flex-grow-1 gap-2">
          <input
            class="form-check-input"
            type="checkbox"
            name="videos"
            id="{{ input_id }}"
            value="{{ node.path }}"
            {% if playlist and node.path in playlist.videos %}checked{% endif %}
          >
          <label class="flex-grow-1 mb-0" for="{{ input_id }}">{{ node.name }}</label>
        </div>
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary"
          data-preview-trigger
          data-video-name="{{ node.name }}"
          data-video-path="{{ node.path }}"
          data-video-src="{{ url_for('serve_video', filename=node.path) }}"
        >Vorschau</button>
      </li>
    {% else %}
      <li class="list-group-item folder collapsed" data-folder>
        <div class="folder-header">
          <span class="folder-toggle folder-title" role="button" tabindex="0" aria-expanded="false">{{ node.path }}/</span>
        </div>
        {% if node.children %}
          <ul class="list-group list-group-flush ms-3 mt-2 folder-children">
            {{ render_video_checkboxes(node.children) }}
          </ul>
        {% else %}
          <div class="folder-children ms-3 mt-2">
            <p class="text-muted small mb-0">Keine Videos in diesem Ordner.</p>
          </div>
        {% endif %}
      </li>
    {% endif %}
  {% endfor %}
{% endmacro %}

{% block content %}
<style>
  .playlist-editor-sidebar {
    position: sticky;
    top: 1rem;
  }

  @media (max-width: 991.98px) {
    .playlist-editor-sidebar {
      position: static;
    }
  }

  .playlist-editor-card {
    display: flex;
    flex-direction: column;
  }

  .playlist-editor-card .card-body {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    flex: 1 1 auto;
    min-height: 0;
  }

  .playlist-editor-tips {
    background: rgba(13, 110, 253, 0.08);
    border: 1px solid rgba(13, 110, 253, 0.15);
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
  }

  .playlist-editor-tips li + li {
    margin-top: 0.25rem;
  }

  .playlist-editor-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  [data-selected-videos-list] {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
  }

  [data-video-search-results-list] {
    max-height: 40vh;
    overflow-y: auto;
  }
</style>
<h2>{% if playlist %}Playlist bearbeiten{% else %}Neue Playlist{% endif %}</h2>
<form method="post" class="mt-3">
  <div class="mb-3">
    <label class="form-label" for="name">Name</label>
    <input class="form-control" id="name" type="text" name="name" value="{{ playlist.name if playlist else '' }}" {% if playlist %}readonly{% endif %} required>
  </div>
  <div class="mb-3">
    <label class="form-label" for="loop_video">Loop-Video</label>
    <select class="form-select" id="loop_video" name="loop_video">
      <option value="">(kein Loop)</option>
      {{ render_loop_options(video_tree) }}
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Playlist Videos</label>
    {% if video_tree %}
      <div class="row g-3 align-items-stretch" data-playlist-editor>
        <div class="col-12 col-lg-5 col-xl-4">
          <section class="card shadow-sm playlist-editor-sidebar playlist-editor-card h-100">
            <div class="card-header">
              <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                <div>
                  <div class="fw-semibold">Playlist-Zusammenstellung</div>
                  <small class="text-muted">Reihenfolge entsprechend der Auswahl</small>
                </div>
                <span class="badge text-bg-secondary" data-selected-videos-count>0 Videos</span>
              </div>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-0" data-selected-videos-empty>
                Aktuell sind keine Videos zur Playlist hinzugefügt.
              </p>
              <ul
                class="list-group flex-grow-1"
                data-selected-videos-list
                data-initial-order='{{ playlist.videos|tojson if playlist else "[]" }}'
              ></ul>
              <div data-selected-videos-inputs hidden></div>
            </div>
          </section>
        </div>
        <div class="col-12 col-lg-7 col-xl-8">
          <section class="card shadow-sm playlist-editor-card h-100">
            <div class="card-header">
              <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                <div>
                  <div class="fw-semibold">Video-Bibliothek</div>
                  <small class="text-muted">Wählen Sie Videos aus den vorhandenen Ordnern aus.</small>
                </div>
                <div class="playlist-editor-actions">
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-video-folders-expand>
                    Alle Ordner öffnen
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-video-folders-collapse>
                    Alle Ordner schließen
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column flex-lg-row align-items-stretch align-items-lg-center gap-2">
                <div class="flex-grow-1">
                  <label class="form-label visually-hidden" for="playlist-video-search">Videos durchsuchen</label>
                  <input
                    id="playlist-video-search"
                    type="search"
                    class="form-control form-control-sm"
                    placeholder="Videos durchsuchen"
                    aria-label="Videos durchsuchen"
                    data-video-search-input
                  >
                </div>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-video-search-clear>Zurücksetzen</button>
                </div>
              </div>
              <div class="d-none" data-video-search-results>
                <h3 class="h6 text-uppercase text-muted">Suchergebnisse</h3>
                <div class="alert alert-warning d-none" role="alert" data-video-search-no-results>
                  Keine Videos gefunden, die den Suchbegriff enthalten.
                </div>
                <ul class="list-group video-list" data-video-search-results-list></ul>
              </div>
              <ul class="list-group video-list video-tree">
                {{ render_video_checkboxes(video_tree) }}
              </ul>
            </div>
          </section>
        </div>
      </div>
    {% else %}
      <p class="text-muted">Keine Videos gefunden.</p>
    {% endif %}
  </div>
  <button type="submit" class="btn btn-primary">Speichern</button>
  <a href="{{ url_for('index') }}" class="btn btn-secondary">Abbrechen</a>
</form>
<div
  class="video-preview-backdrop d-none"
  role="dialog"
  aria-modal="true"
  aria-labelledby="video-preview-title"
  data-preview-modal
>
  <div class="video-preview-dialog">
    <div class="video-preview-header">
      <h3 class="h5 mb-0" id="video-preview-title" data-preview-title>Vorschau</h3>
      <button
        type="button"
        class="btn-close btn-close-white"
        aria-label="Schließen"
        data-preview-close
      ></button>
    </div>
    <div class="video-preview-body">
      <video controls autoplay playsinline data-preview-video></video>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.querySelector('[data-video-search-input]');
    const clearButton = document.querySelector('[data-video-search-clear]');
    const resultsWrapper = document.querySelector('[data-video-search-results]');
    const resultsList = document.querySelector('[data-video-search-results-list]');
    const noResultsAlert = document.querySelector('[data-video-search-no-results]');

    const fileEntries = Array.from(document.querySelectorAll('[data-video-entry]')).map((entry) => {
      const checkbox = entry.querySelector('input[name="videos"]');
      return {
        element: entry,
        checkbox,
        path: entry.dataset.videoPath || '',
        name: entry.dataset.videoName || entry.dataset.videoPath || '',
        previewSrc: entry.dataset.videoSrc || '',
      };
    });

    const fileEntryMap = new Map(
      fileEntries.filter((entry) => entry.path).map((entry) => [entry.path, entry])
    );

    const selectedList = document.querySelector('[data-selected-videos-list]');
    const selectedEmptyState = document.querySelector('[data-selected-videos-empty]');
    const selectedCount = document.querySelector('[data-selected-videos-count]');
    const selectedEntryMap = new Map();
    const orderedInputsContainer = document.querySelector('[data-selected-videos-inputs]');
    const selectedListInitialOrder = (() => {
      if (!selectedList || !selectedList.dataset.initialOrder) {
        return [];
      }
      try {
        return JSON.parse(selectedList.dataset.initialOrder);
      } catch (error) {
        return [];
      }
    })();

    const updateSelectedSummary = () => {
      if (!selectedList) {
        return;
      }
      const itemCount = selectedList.querySelectorAll('[data-selected-video-item]').length;
      if (selectedEmptyState) {
        selectedEmptyState.classList.toggle('d-none', itemCount > 0);
      }
      if (selectedCount) {
        const label = itemCount === 1 ? '1 Video' : `${itemCount} Videos`;
        selectedCount.textContent = label;
      }
    };

    const refreshOrderedInputs = () => {
      if (!orderedInputsContainer) {
        return;
      }
      orderedInputsContainer.innerHTML = '';
      if (!selectedList) {
        return;
      }
      const items = Array.from(selectedList.querySelectorAll('[data-selected-video-item]'));
      items.forEach((item) => {
        const path = item.dataset.selectedVideoItem || '';
        if (!path) {
          return;
        }
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'ordered_videos';
        input.value = path;
        orderedInputsContainer.appendChild(input);
      });
    };

    const updateReorderControls = () => {
      if (!selectedList) {
        return;
      }
      const items = Array.from(selectedList.querySelectorAll('[data-selected-video-item]'));
      items.forEach((item, index) => {
        const moveUpButton = item.querySelector('[data-move-up]');
        const moveDownButton = item.querySelector('[data-move-down]');
        if (moveUpButton) {
          moveUpButton.disabled = index === 0;
        }
        if (moveDownButton) {
          moveDownButton.disabled = index === items.length - 1;
        }
      });
    };

    const moveSelectedItem = (item, direction) => {
      if (!selectedList) {
        return;
      }
      if (direction < 0) {
        const previous = item.previousElementSibling;
        if (!previous) {
          return;
        }
        selectedList.insertBefore(item, previous);
      } else if (direction > 0) {
        const next = item.nextElementSibling;
        if (!next) {
          return;
        }
        selectedList.insertBefore(item, next.nextSibling);
      }
      refreshOrderedInputs();
      updateReorderControls();
      updateSelectedSummary();
    };

    const buildSelectedListItem = (entry) => {
      const item = document.createElement('li');
      item.className = 'list-group-item d-flex align-items-start align-items-lg-center justify-content-between gap-2 flex-wrap';
      item.dataset.selectedVideoItem = entry.path || '';

      const info = document.createElement('div');
      info.className = 'flex-grow-1';

      const title = document.createElement('div');
      title.className = 'fw-semibold text-truncate';
      title.textContent = entry.name || entry.path || '';
      info.append(title);

      const actions = document.createElement('div');
      actions.className = 'd-flex align-items-center gap-2 flex-shrink-0 flex-wrap justify-content-end';

      const reorderGroup = document.createElement('div');
      reorderGroup.className = 'btn-group btn-group-sm';

      const moveUpButton = document.createElement('button');
      moveUpButton.type = 'button';
      moveUpButton.className = 'btn btn-outline-secondary';
      moveUpButton.dataset.moveUp = 'true';
      moveUpButton.innerHTML = '<span aria-hidden="true">▲</span><span class="visually-hidden">Nach oben</span>';
      moveUpButton.addEventListener('click', () => {
        moveSelectedItem(item, -1);
        moveUpButton.focus({ preventScroll: true });
      });

      const moveDownButton = document.createElement('button');
      moveDownButton.type = 'button';
      moveDownButton.className = 'btn btn-outline-secondary';
      moveDownButton.dataset.moveDown = 'true';
      moveDownButton.innerHTML = '<span aria-hidden="true">▼</span><span class="visually-hidden">Nach unten</span>';
      moveDownButton.addEventListener('click', () => {
        moveSelectedItem(item, 1);
        moveDownButton.focus({ preventScroll: true });
      });

      reorderGroup.append(moveUpButton, moveDownButton);
      actions.append(reorderGroup);

      if (entry.previewSrc) {
        const previewButton = document.createElement('button');
        previewButton.type = 'button';
        previewButton.className = 'btn btn-sm btn-outline-secondary';
        previewButton.textContent = 'Vorschau';
        previewButton.dataset.previewTrigger = 'true';
        previewButton.dataset.videoName = entry.name || entry.path || '';
        previewButton.dataset.videoPath = entry.path || '';
        previewButton.dataset.videoSrc = entry.previewSrc;
        actions.append(previewButton);
      }

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'btn btn-sm btn-outline-danger';
      removeButton.textContent = 'Entfernen';
      removeButton.addEventListener('click', () => {
        if (entry.checkbox) {
          entry.checkbox.checked = false;
          entry.checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      actions.append(removeButton);

      item.append(info, actions);
      return item;
    };

    const syncSelectedEntry = (entry) => {
      if (!selectedList || !entry.path || !entry.checkbox) {
        return;
      }

      const existingItem = selectedEntryMap.get(entry.path);
      if (entry.checkbox.checked) {
        if (!existingItem) {
          const item = buildSelectedListItem(entry);
          selectedEntryMap.set(entry.path, item);
          selectedList.appendChild(item);
        }
      } else if (existingItem) {
        existingItem.remove();
        selectedEntryMap.delete(entry.path);
      }

      updateSelectedSummary();
      refreshOrderedInputs();
      updateReorderControls();
    };

    const applyInitialOrder = () => {
      if (!selectedList) {
        return;
      }
      if (selectedListInitialOrder.length === 0) {
        refreshOrderedInputs();
        updateReorderControls();
        updateSelectedSummary();
        return;
      }
      const itemsByPath = new Map(
        Array.from(selectedList.querySelectorAll('[data-selected-video-item]')).map((item) => [
          item.dataset.selectedVideoItem || '',
          item,
        ])
      );
      selectedListInitialOrder.forEach((path) => {
        const item = itemsByPath.get(path);
        if (item) {
          selectedList.appendChild(item);
        }
      });
      refreshOrderedInputs();
      updateReorderControls();
      updateSelectedSummary();
    };

    let activePreviewEntry = null;

    const highlightPreviewEntry = (path) => {
      if (!path) {
        return;
      }

      const entry = fileEntryMap.get(path);
      if (!entry) {
        return;
      }

      if (activePreviewEntry && activePreviewEntry.element !== entry.element) {
        activePreviewEntry.element.classList.remove('preview-active');
      }

      entry.element.classList.add('preview-active');
      activePreviewEntry = entry;
    };

    const previewModal = document.querySelector('[data-preview-modal]');
    const previewVideo = previewModal ? previewModal.querySelector('[data-preview-video]') : null;
    const previewTitle = previewModal ? previewModal.querySelector('[data-preview-title]') : null;
    const previewCloseButtons = previewModal ? previewModal.querySelectorAll('[data-preview-close]') : [];

    const isPreviewOpen = () => previewModal && !previewModal.classList.contains('d-none');

    const closePreview = () => {
      if (!previewModal) {
        return;
      }
      if (previewVideo) {
        previewVideo.pause();
        previewVideo.removeAttribute('src');
        previewVideo.load();
      }
      previewModal.classList.add('d-none');
      document.body.classList.remove('overflow-hidden');
    };

    const openPreview = (videoName, videoSrc, videoPath = '') => {
      if (!previewModal || !previewVideo || !videoSrc) {
        return;
      }
      if (previewTitle) {
        const title = videoName ? `Vorschau: ${videoName}` : 'Vorschau';
        previewTitle.textContent = title;
      }
      previewVideo.src = videoSrc;
      previewVideo.load();
      highlightPreviewEntry(videoPath);
      previewModal.classList.remove('d-none');
      document.body.classList.add('overflow-hidden');
      const playPromise = previewVideo.play();
      if (playPromise && typeof playPromise.catch === 'function') {
        playPromise.catch(() => {});
      }
    };

    previewCloseButtons.forEach((button) => {
      button.addEventListener('click', () => {
        closePreview();
      });
    });

    if (previewModal) {
      previewModal.addEventListener('click', (event) => {
        if (event.target === previewModal) {
          closePreview();
        }
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && isPreviewOpen()) {
        closePreview();
      }
    });

    document.addEventListener('click', (event) => {
      const trigger = event.target instanceof HTMLElement ? event.target.closest('[data-preview-trigger]') : null;
      if (!trigger) {
        return;
      }
      event.preventDefault();
      const videoName = trigger.dataset.videoName || '';
      const videoSrc = trigger.dataset.videoSrc || '';
      const videoPath = trigger.dataset.videoPath || '';
      const closestEntry = trigger.closest('[data-video-entry]');
      if (closestEntry && closestEntry.dataset.videoPath) {
        highlightPreviewEntry(closestEntry.dataset.videoPath);
      } else {
        highlightPreviewEntry(videoPath);
      }
      openPreview(videoName, videoSrc, videoPath);
    });

    const expandAllButton = document.querySelector('[data-video-folders-expand]');
    const collapseAllButton = document.querySelector('[data-video-folders-collapse]');
    const folderElements = Array.from(document.querySelectorAll('.video-tree [data-folder]'));

    const updateFolderState = (folderElement, expanded) => {
      folderElement.classList.toggle('collapsed', !expanded);
      folderElement.classList.toggle('expanded', expanded);
      const toggle = folderElement.querySelector('.folder-toggle');
      if (toggle) {
        toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      }
    };

    if (expandAllButton) {
      expandAllButton.addEventListener('click', () => {
        folderElements.forEach((folder) => updateFolderState(folder, true));
      });
    }

    if (collapseAllButton) {
      collapseAllButton.addEventListener('click', () => {
        folderElements.forEach((folder) => updateFolderState(folder, false));
      });
    }

    if (!searchInput || !resultsWrapper || !resultsList) {
      return;
    }

    const revealEntry = (entryElement) => {
      let folder = entryElement.parentElement.closest('.folder');
      while (folder) {
        updateFolderState(folder, true);
        folder = folder.parentElement.closest('.folder');
      }
      entryElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      const checkbox = entryElement.querySelector('input[name="videos"]');
      if (checkbox) {
        checkbox.focus({ preventScroll: true });
      }
    };

    const buildResultItem = (entry) => {
      const item = document.createElement('li');
      item.className = 'list-group-item d-flex align-items-center justify-content-between gap-2';

      const label = document.createElement('label');
      label.className = 'form-check-label flex-grow-1 d-flex align-items-center gap-2 mb-0';

      const mirrorCheckbox = document.createElement('input');
      mirrorCheckbox.type = 'checkbox';
      mirrorCheckbox.className = 'form-check-input';
      mirrorCheckbox.checked = entry.checkbox ? entry.checkbox.checked : false;

      mirrorCheckbox.addEventListener('change', () => {
        if (entry.checkbox) {
          entry.checkbox.checked = mirrorCheckbox.checked;
          entry.checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });

      const textSpan = document.createElement('span');
      textSpan.className = 'flex-grow-1';
      textSpan.textContent = entry.path;

      label.append(mirrorCheckbox, textSpan);

      const actions = document.createElement('div');
      actions.className = 'd-flex align-items-center gap-2';

      if (entry.previewSrc) {
        const previewButton = document.createElement('button');
        previewButton.type = 'button';
        previewButton.className = 'btn btn-sm btn-outline-secondary';
        previewButton.textContent = 'Vorschau';
        previewButton.dataset.previewTrigger = 'true';
        previewButton.dataset.videoName = entry.name || entry.path;
        previewButton.dataset.videoPath = entry.path || '';
        previewButton.dataset.videoSrc = entry.previewSrc;
        actions.append(previewButton);
      }

      const showButton = document.createElement('button');
      showButton.type = 'button';
      showButton.className = 'btn btn-sm btn-outline-primary';
      showButton.textContent = 'Anzeigen';
      showButton.addEventListener('click', () => {
        revealEntry(entry.element);
      });

      actions.append(showButton);

      item.append(label, actions);
      return item;
    };

    const clearResults = () => {
      resultsList.innerHTML = '';
      resultsWrapper.classList.add('d-none');
      if (noResultsAlert) {
        noResultsAlert.classList.add('d-none');
      }
    };

    const updateResults = () => {
      const query = (searchInput.value || '').trim().toLowerCase();
      if (!query) {
        clearResults();
        return;
      }

      const matches = fileEntries.filter((entry) => entry.path.toLowerCase().includes(query));
      resultsList.innerHTML = '';

      if (matches.length === 0) {
        resultsWrapper.classList.remove('d-none');
        resultsList.classList.add('d-none');
        if (noResultsAlert) {
          noResultsAlert.classList.remove('d-none');
        }
        return;
      }

      resultsWrapper.classList.remove('d-none');
      resultsList.classList.remove('d-none');
      if (noResultsAlert) {
        noResultsAlert.classList.add('d-none');
      }

      matches.forEach((entry) => {
        resultsList.appendChild(buildResultItem(entry));
      });
    };

    searchInput.addEventListener('input', updateResults);

    fileEntries.forEach((entry) => {
      if (entry.checkbox) {
        entry.checkbox.addEventListener('change', () => {
          syncSelectedEntry(entry);
          if ((searchInput.value || '').trim()) {
            updateResults();
          }
        });
        syncSelectedEntry(entry);
      }
    });

    applyInitialOrder();

    if (clearButton) {
      clearButton.addEventListener('click', () => {
        searchInput.value = '';
        clearResults();
        searchInput.focus();
      });
    }
  });
</script>
{% endblock %}
