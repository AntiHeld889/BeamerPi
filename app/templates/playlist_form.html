{% extends "base.html" %}

{% macro render_loop_options(nodes, level=0) %}
  {% for node in nodes %}
    {% if node.is_file %}
      {% set indent = '&nbsp;' * (level * 4) %}
      <option value="{{ node.path }}" {% if playlist and playlist.loop_video == node.path %}selected{% endif %}>{{ indent | safe }}{{ node.name }}</option>
    {% else %}
      {% set indent = '&nbsp;' * (level * 4) %}
      <option value="" disabled class="bg-light text-muted">{{ indent | safe }}{{ node.path }}/</option>
      {{ render_loop_options(node.children, level + 1) }}
    {% endif %}
  {% endfor %}
{% endmacro %}

{% macro render_video_checkboxes(nodes) %}
  {% for node in nodes %}
    {% if node.is_file %}
      {% set input_id = 'video-' ~ node.path|replace('/', '_')|replace('.', '_') %}
      <li
        class="list-group-item d-flex align-items-center justify-content-between gap-2"
        data-video-entry
        data-video-path="{{ node.path }}"
        data-video-name="{{ node.name }}"
        data-video-src="{{ url_for('serve_video', filename=node.path) }}"
      >
        <div class="d-flex align-items-center flex-grow-1 gap-2">
          <input
            class="form-check-input"
            type="checkbox"
            name="videos"
            id="{{ input_id }}"
            value="{{ node.path }}"
            {% if playlist and node.path in playlist.videos %}checked{% endif %}
          >
          <label class="flex-grow-1 mb-0" for="{{ input_id }}">{{ node.name }}</label>
        </div>
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary"
          data-preview-trigger
          data-video-name="{{ node.name }}"
          data-video-path="{{ node.path }}"
          data-video-src="{{ url_for('serve_video', filename=node.path) }}"
        >Vorschau</button>
      </li>
    {% else %}
      <li class="list-group-item folder collapsed" data-folder>
        <div class="folder-header">
          <span class="folder-toggle folder-title" role="button" tabindex="0" aria-expanded="false">{{ node.path }}/</span>
        </div>
        {% if node.children %}
          <ul class="list-group list-group-flush ms-3 mt-2 folder-children">
            {{ render_video_checkboxes(node.children) }}
          </ul>
        {% else %}
          <div class="folder-children ms-3 mt-2">
            <p class="text-muted small mb-0">Keine Videos in diesem Ordner.</p>
          </div>
        {% endif %}
      </li>
    {% endif %}
  {% endfor %}
{% endmacro %}

{% block extra_styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/playlist.css') }}">
{% endblock %}

{% block content %}
<h2>{% if playlist %}Playlist bearbeiten{% else %}Neue Playlist{% endif %}</h2>
<form method="post" class="mt-3">
  <div class="mb-3">
    <label class="form-label" for="name">Name</label>
    <input class="form-control" id="name" type="text" name="name" value="{{ playlist.name if playlist else '' }}" {% if playlist %}readonly{% endif %} required>
  </div>
  <div class="mb-3">
    <label class="form-label" for="loop_video">Loop-Video</label>
    <select class="form-select" id="loop_video" name="loop_video">
      <option value="">(kein Loop)</option>
      {{ render_loop_options(video_tree) }}
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Playlist Videos</label>
    {% if video_tree %}
      <div class="row g-3 align-items-stretch" data-playlist-editor>
        <div class="col-12 col-lg-5 col-xl-4">
          <section class="card shadow-sm playlist-editor-sidebar playlist-editor-card h-100">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">Playlist-Zusammenstellung</div>
                <small class="text-muted">Reihenfolge entsprechend der Auswahl</small>
              </div>
              <span class="badge text-bg-secondary" data-selected-videos-count>0 Videos</span>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-0" data-selected-videos-empty>
                Aktuell sind keine Videos zur Playlist hinzugefügt.
              </p>
              <ul
                class="list-group flex-grow-1"
                data-selected-videos-list
                data-initial-order='{{ playlist.videos|tojson if playlist else "[]" }}'
              ></ul>
              <div data-selected-videos-inputs hidden></div>
            </div>
          </section>
        </div>
        <div class="col-12 col-lg-7 col-xl-8">
          <section class="card shadow-sm playlist-editor-card">
            <div class="card-header">
              <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                <div>
                  <div class="fw-semibold">Video-Bibliothek</div>
                  <small class="text-muted">Wählen Sie Videos aus den vorhandenen Ordnern aus.</small>
                </div>
                <div class="playlist-editor-actions">
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-video-folders-expand>
                    Alle Ordner öffnen
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-video-folders-collapse>
                    Alle Ordner schließen
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column flex-lg-row align-items-stretch align-items-lg-center gap-2">
                <div class="flex-grow-1">
                  <label class="form-label visually-hidden" for="playlist-video-search">Videos durchsuchen</label>
                  <input
                    id="playlist-video-search"
                    type="search"
                    class="form-control form-control-sm"
                    placeholder="Videos durchsuchen"
                    aria-label="Videos durchsuchen"
                    data-video-search-input
                  >
                </div>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-video-search-clear>Zurücksetzen</button>
                </div>
              </div>
              <div class="d-none" data-video-search-results>
                <h3 class="h6 text-uppercase text-muted">Suchergebnisse</h3>
                <div class="alert alert-warning d-none" role="alert" data-video-search-no-results>
                  Keine Videos gefunden, die den Suchbegriff enthalten.
                </div>
                <ul class="list-group video-list" data-video-search-results-list></ul>
              </div>
              <ul class="list-group video-list video-tree">
                {{ render_video_checkboxes(video_tree) }}
              </ul>
            </div>
          </section>
        </div>
      </div>
    {% else %}
      <p class="text-muted">Keine Videos gefunden.</p>
    {% endif %}
  </div>
  <button type="submit" class="btn btn-primary">Speichern</button>
  <a href="{{ url_for('index') }}" class="btn btn-secondary">Abbrechen</a>
</form>
<div
  class="video-preview-backdrop d-none"
  role="dialog"
  aria-modal="true"
  aria-labelledby="video-preview-title"
  data-preview-modal
>
  <div class="video-preview-dialog">
    <div class="video-preview-header">
      <h3 class="h5 mb-0" id="video-preview-title" data-preview-title>Vorschau</h3>
      <button
        type="button"
        class="btn-close btn-close-white"
        aria-label="Schließen"
        data-preview-close
      ></button>
    </div>
    <div class="video-preview-body">
      <video controls autoplay playsinline data-preview-video></video>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script defer src="{{ url_for('static', filename='js/playlist_form.js') }}"></script>
{% endblock %}
